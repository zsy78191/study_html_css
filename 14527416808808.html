<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  UINavigationBar的继承与定制 - zsy78191
  

  </title>
  <link href="atom.xml" rel="alternate" title="zsy78191" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        <li id="menu_item_index"><a href="index.html">HOME</a></li>
        <li id="menu_item_archives"><a href="archives.html">Archives</a></li>
        <li id="menu_item_about"><a href="about.html">ABOUT</a></li>
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" action="http://google.com/search" method="get">
    <input type="hidden" name="q" value="site:" />
    <input tabindex="1" type="search" name="q"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; zsy78191</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
       
       <li><a href="index.html">HOME</a></li>
    <li><a href="archives.html">Archives</a></li>
    <li><a href="about.html">ABOUT</a></li>

    <li><label>Categories</label></li>

        
            <li><a href="%E5%8F%82%E8%80%83.html">参考</a></li>
        
            <li><a href="Note.html">Note</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
 <script type="text/javascript">
  $(function(){
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="row">
  <div class="large-8 medium-8 columns">
      <div class="markdown-body article-wrap">
       <div class="article">
          
          <h1>UINavigationBar的继承与定制</h1>
     
        <div class="read-more clearfix">
          <span class="date">2016/1/14</span>

          <span>posted in&nbsp;</span> 
          
              <span class="posted-in"><a href='Note.html'>Note</a></span>
           
         
          <span class="comments">
            

            
          </span>

        </div>
      </div><!-- article -->

      <div class="article-content">
      <p>我们在iOS项目开发中，有些时候需要修改标准控件的样式，我们今天就围绕一个具体项目需求，进行<code>UINavigationBar</code>的继承与改造。</p>

<h1 id="toc_0">UIApperance协议属性定制</h1>

<p>我们在<code>UINavigationBar.h</code>头文件中，看到如下修改NavigationBar背景颜色的属性</p>

<pre><code>@property(nullable, nonatomic,strong) UIColor *barTintColor NS_AVAILABLE_IOS(7_0) UI_APPEARANCE_SELECTOR;  // default is nil
</code></pre>

<p>注意到<code>UI_APPEARANCE_SELECTOR</code>这个宏了么，用这个宏标记的属性，都是可以通过<code>UIApperance</code>协议进行全局设置的属性。说的更直白一点，就是可以一次性，修改项目中所有的这个类的默认属性。</p>

<p>例如在iOS6之前，<code>UILabel</code>的默认背景颜色不是透明色，而是白色。我们就可以使用如下方法，修改<code>UILabel</code>的默认背景色</p>

<pre><code> [[UILabel appearance] setBackgroundColor:[UIColor clearColor]];
</code></pre>

<p><code>UIApperance</code>协议就是这么神奇，所有的UIKit控件都遵守了这个协议，所有标记了<code>UI_APPEARANCE_SELECTOR</code>宏的属性，都可以使用<code>appearance</code>实例修改默认值，是不是很炫酷。</p>

<h1 id="toc_1">项目需求</h1>

<p>上面一段与本文正题无关，下面我们看一下本文的项目需求</p>

<p><img src="/img/bVsd7L" alt="图片描述"/></p>

<h1 id="toc_2">分析</h1>

<p>这个页面就是一个标准的<code>NavigationController</code> + <code>TableViewContoller</code>组合实现的设置页面，导航条和Table的样式需要订制。</p>

<p>前面说到的<code>UIApperance</code>协议是可以实现的，我们换一种更为普遍的方式实现，<strong>继承</strong>。</p>

<p>我们继承<code>UINavigationBar</code>，创建子类<code>FWBar</code>。我们使用storyboard实例化大体框架模型，并将<code>NavigationViewController</code>的<code>NavigationBar</code>设置为我们的<code>FWBar</code>类，并将<code>UITableView</code>设置为<code>Static</code>静态模式，直接编辑了<code>Cell</code>的内容。</p>

<p><img src="/img/bVsd8s" alt="图片描述"/></p>

<p>在<code>FWBar.m</code>中加入如下代码<br/>
```<br/>
- (void)awakeFromNib<br/>
{<br/>
    [self setBackgroundImage:[UIImage new] forBarMetrics:UIBarMetricsCompact];<br/>
    self.shadowImage = [UIImage new];</p>

<pre><code>//把之前的View统统隐藏
[self.subviews enumerateObjectsUsingBlock:^(__kindof UIView * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
    [obj setHidden:YES];
}];


[self addSubview:self.fakeBackgroundView];
self.fakeBackgroundView.userInteractionEnabled = NO;
[self sendSubviewToBack:self.fakeBackgroundView];

self.titleTextAttributes = @{
                             NSFontAttributeName: [UIFont fontWithName:@&quot;NotoSansHans-DemiLight&quot; size:16],
                             NSForegroundColorAttributeName:[UIColor colorWithRed:57.0/255 green:207.0/255 blue:218.0/255 alpha:1]
                             };

//rgba(165, 195, 205, 1)
self.tintColor = [UIColor colorWithRed:165.0/255 green:195.0/255 blue:205.0/255 alpha:1];
</code></pre>

<p>}<br/>
```</p>

<p><strong>解释</strong> 因为原生的NaviBar背景View下方有一条灰色的边，这条边不是用layer生成的，我没搞明白是怎么实现的，所以直接将这个View隐藏掉了。顺便吧<code>shadowImage</code>也换成空图。</p>

<p>这里的<code>self.fakeBackgroundView</code>是我们添加的背景，颜色是白色。这里我们将它移到最下层，并且触摸属性关掉，<code>userInteractionEnabled</code>设为<code>NO</code>。</p>

<p><code>titleTextAttributes</code>这个属性，是用来修改title的样式的。</p>

<p><code>tintColor</code>这个属性，是用来修改导航条左右按钮颜色的。</p>

<p>这些操作做完，还不够。</p>

<p><strong>我们无法通过暴露出来的接口修改左右按钮的字体和位置。这也是我们选择继承而不是UIApperance的原因</strong></p>

<h1 id="toc_3">继承大杀器，高度自定义</h1>

<pre><code>- (void)didAddSubview:(UIView *)subview
{
    NSLog(@&quot;%@&quot;,subview);
    if ([subview isKindOfClass:NSClassFromString(@&quot;UINavigationButton&quot;)]) {
        if ([subview isKindOfClass:[UIButton class]]) {
            
            [(UIButton*)subview setAttributedTitle:[[NSAttributedString alloc] initWithString:[(UIButton*)subview titleForState:UIControlStateNormal] attributes:@{
                                                                                                                                                                   NSFontAttributeName: [UIFont fontWithName:@&quot;AvenirNext-Regular&quot; size:17],
                                                                                                                                                                   NSForegroundColorAttributeName:self.tintColor
                                                                                                                                                                   }] forState:UIControlStateNormal];
        }
    }
}

- (void)layoutSubviews
{
    [super layoutSubviews];
    
    [self.subviews enumerateObjectsUsingBlock:^(__kindof UIView * _Nonnull subview, NSUInteger idx, BOOL * _Nonnull stop) {
        if ([subview isKindOfClass:NSClassFromString(@&quot;UINavigationButton&quot;)]) {
            if ([subview isKindOfClass:[UIButton class]] &amp;&amp; subview.frame.origin.x &lt; self.frame.size.width/2) {
                [subview setFrame:({
                    CGRect rect = subview.frame;
                    rect.origin.x = 8;
                    rect.size.width = 69;
                    rect;
                })];
            }
        }
        
    }];
}
</code></pre>

<p><strong>解释</strong> 重写<code>- (void)didAddSubview:(UIView *)subview</code>方法，检测了系统控件根据<code>NavigationItem</code>向<code>NavigationBar</code>添加按钮这个事件，然后对按钮进行甄别，定制。</p>

<p>我们找到<code>Cancel</code>这个按钮，他虽然是<code>UINavigationButton</code>类型，但是一定是继承了<code>UIButton</code>，所以我们直接强转成她的父类，修改其文字字体和frame。</p>

<p>重写<code>layoutSubviews</code>这个方法，是为了实时更新我们的按钮位置。这个其实也可以不更改的，但是我们的项目需求中，<code>Cancel</code>这个字段太长，字体变大以后导致了显示不全，所以我们将这个做按钮的frame变大了。</p>

<p>注意几点</p>

<ol>
<li><p><code>NSClassFromString(@&quot;UINavigationButton&quot;)</code>这个方法是我们无法获取内部类的时候，获取Class类型的方法。<code>UINavigationButton</code>这个类名是NSLog输出时看到的。</p></li>
<li><p>这一段使用了特殊的语法糖，有兴趣了解的参考<a href="http://blog.sunnyxx.com/2014/08/02/objc-weird-code/">这篇sunnyxx大神的博文</a>，全文搜索关键字<code>小括号内联复合表达式</code></p></li>
</ol>

<pre><code>[subview setFrame:({
                    CGRect rect = subview.frame;
                    rect.origin.x = 8;
                    rect.size.width = 69;
                    rect;
                })];
</code></pre>

<p>最后的实现效果。</p>

<p><img src="/img/bVseck" alt="图片描述"/></p>

<h1 id="toc_4">结语</h1>

<p>截屏的效果不是太好，细心的朋友可能会发现，我们的<code>FWBar</code>在<code>TableView</code>向上滑动的过程中会渐出阴影。</p>

<p>我把这段代码分享给大家，但是这段代码偷懒没用KVO，而是用了<code>ReactiveCocoa</code>这个庞大的庞大框架的小小功能，所以，就没放倒教程里。</p>

<pre><code>- (void)didMoveToSuperview
{
    [super didMoveToSuperview];
    
    UIViewController *presentingViewController = [UIApplication sharedApplication].keyWindow.rootViewController;
    while (presentingViewController.presentedViewController) presentingViewController = presentingViewController.presentedViewController;

    __block BOOL has = NO;
    [[presentingViewController childViewControllers] enumerateObjectsUsingBlock:^(__kindof UIViewController * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        if ([obj isKindOfClass:[UINavigationController class]]) {
            [[obj childViewControllers] enumerateObjectsUsingBlock:^(__kindof UIViewController * _Nonnull obj2, NSUInteger idx, BOOL * _Nonnull stop) {
                if ([obj2 isKindOfClass:[UITableViewController class]]) {
                    has = YES;
                    UITableViewController* tVC = obj2;
                    if (self.tableViewOffsetDisposable) {
                        [self.tableViewOffsetDisposable dispose];
                    }
                    self.tableViewOffsetDisposable = [RACObserve(tVC.tableView, contentOffset) subscribeNext:^(id x) {
                        CGPoint p = [x CGPointValue];
                        
                        if (p.y &lt;= 0 &amp;&amp; p.y &gt;= - 64) {
                            self.fakeBackgroundView.layer.shadowOpacity = fabs(64 + p.y) / 64 * 0.7;
                        }
                        else if (p.y &gt; 0)
                        {
                            if (self.fakeBackgroundView.layer.shadowOpacity != 0.7) {
                                self.fakeBackgroundView.layer.shadowOpacity = 0.7;
                            }
                        }
                        else
                        {
                            if (self.fakeBackgroundView.layer.shadowOpacity != 0) {
                                self.fakeBackgroundView.layer.shadowOpacity = 0;
                            }
                        }
                    }];
                }
            }];
        }
    }];
}
</code></pre>

      </div>

      <div class="row">
        <div class="large-6 columns">
        <p class="text-left" style="padding:15px 0px;">
      
          <a href="14500756041561.html" 
          title="Previous Post: SwizzleMethod的黑魔法">&laquo; SwizzleMethod的黑魔法</a>
      
        </p>
        </div>
        <div class="large-6 columns">
      <p class="text-right" style="padding:15px 0px;">
      
          <a  href="14509257553074.html" 
          title="Next Post: UITableView 编辑模式详解">UITableView 编辑模式详解 &raquo;</a>
      
      </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
          
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"zsy78191"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->

          

          
        </div>
      </div>
    </div><!-- article-wrap -->
  </div><!-- large 8 -->




 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>zsy78191</h1>
                <div class="site-des">个人博客</div>
                <div class="social">











  <a class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>
              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="%E5%8F%82%E8%80%83.html"><strong>参考</strong></a>
        
            <a href="Note.html"><strong>Note</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="14543937535743.html"></a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14531716978294.html">悦客接口需求</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14556955527053.html">1. 编辑地址接口，总是返回 ‘手机号填写有误哦’</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14502520092955.html">Background Modes Tutorial: Getting Started</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14561077487642.html">HTML</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    



  </body>
</html>
